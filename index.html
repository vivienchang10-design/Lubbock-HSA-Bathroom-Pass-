<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HSA Lubbock · Bathroom Pass</title>
<style>
  :root{--pad:14px;--radius:16px;--border:#ddd;--muted:#666;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:#111;background:#fff;}
  header,main{max-width:1100px;margin:0 auto;padding:var(--pad);}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .grow{flex:1}
  .card{border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);box-shadow:0 1px 4px rgba(0,0,0,.04);background:#fff}
  input[type=text],select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);font-size:16px}
  button{padding:12px 16px;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer;font-size:16px}
  button.primary{border-color:#222}
  .pill{border:1px solid var(--border);border-radius:999px;padding:6px 12px;font-size:14px;background:#fff}
  .muted{color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  ul{list-style:none;padding:0;margin:0}
  li.item{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
  .badge{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:3px 8px}
  .danger{color:#b00020;font-weight:600}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left}
  th{font-size:12px;color:#444}
  .hidden{display:none}
  .alert{border:1px dashed #f3b;background:#fff7fb;padding:10px 12px;border-radius:12px;margin-top:8px}
  .list{position:relative}
  .dropdown{position:absolute;left:0;right:0;top:100%;background:#fff;border:1px solid var(--border);border-radius:12px;z-index:10;max-height:260px;overflow:auto}
  .dropdown div{padding:10px 12px;cursor:pointer}
  .dropdown div:hover{background:#f6f6f6}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
  .warn{background:#fff6f6;border-color:#f4caca}
</style>
<script>
  // 固定到正式域名，避免 OAuth 未授权域名
  (function(){
    var host = location.hostname;
    if(host!=="lubbock-hsa-bathroom-pass.vercel.app" && host!=="localhost"){
      location.href="https://lubbock-hsa-bathroom-pass.vercel.app";
    }
  })();
</script>
</head>
<body>
<header class="row">
  <div class="grow">
    <h1 style="margin:0 0 4px;">Bathroom Pass</h1>
    <div id="who" class="muted">Not signed in</div>
  </div>
  <div class="row">
    <button id="scanBtn" class="pill">Scan</button>
    <button id="exportBtn" class="pill">Export last 7 days (CSV)</button>
    <label id="importWrap" class="pill hidden">
      Import roster (CSV)
      <input id="csv" type="file" accept=".csv" class="hidden" />
    </label>
    <button id="loginBtn" class="primary">Sign in with Google</button>
    <button id="logoutBtn" class="hidden">Logout</button>
  </div>
</header>

<main>
  <section class="card">
    <div class="row">
      <div class="grow list">
        <label class="muted">Student</label>
        <input id="studentInput" type="text" placeholder="Search or type student name" autocomplete="off"/>
        <div id="dropdown" class="dropdown hidden"></div>
        <div class="chips" id="recentChips"></div>
      </div>
      <div>
        <label class="muted">Grade</label>
        <select id="gradeSel"><option value="">All</option></select>
      </div>
      <div>
        <label class="muted">Homeroom</label>
        <select id="homeSel"><option value="">All</option></select>
      </div>
      <div class="row" style="align-items:flex-end">
        <label class="row" style="gap:6px;font-size:14px;margin-top:18px;"><input id="emg" type="checkbox"/> Emergency/Exempt</label>
        <button id="recordBtn" class="primary">Record</button>
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <div class="muted grow">• Max 3/day (America/Chicago). Emergency entries don’t count.</div>
      <div class="row" style="gap:6px">
        <label class="muted">Alert if 7-day total &gt;</label>
        <input id="alertN" type="text" value="5" style="width:60px"/>
      </div>
    </div>
    <div id="msg" class="muted" style="margin-top:6px;"></div>
    <div id="domainAlert" class="alert hidden"></div>
    <video id="video" class="hidden" playsinline style="width:100%;max-height:260px;margin-top:8px;border-radius:12px;border:1px solid #eee"></video>
  </section>

  <section class="grid" style="margin-top:16px;">
    <div class="card">
      <h3 style="margin:0 0 8px;">Today’s Counts (Max 3)</h3>
      <div id="emptyMsg" class="muted">No records yet.</div>
      <ul id="list"></ul>
      <div id="alerts" class="card warn hidden" style="margin-top:12px;">
        <strong>Alerts (7-day &gt; N):</strong>
        <ul id="alertList" style="margin-top:6px"></ul>
      </div>
    </div>
    <div class="card">
      <h3 style="margin:0 0 8px;">Latest Records (today)</h3>
      <table>
        <thead><tr><th>Time (CT)</th><th>Student</th><th>Grade</th><th>Homeroom</th><th>Teacher</th><th>Emergency</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* ====== Firebase config (yours) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyBXYe18Z-KN6sS_QdGXEqW8Zb4RBxtYoVM",
  authDomain: "lubbock-hsa-bathroom-pass.firebaseapp.com",
  projectId: "lubbock-hsa-bathroom-pass",
  storageBucket: "lubbock-hsa-bathroom-pass.firebasestorage.app",
  messagingSenderId: "20266028833",
  appId: "1:20266028833:web:5219b6cfa07da654807860",
  measurementId: "G-ENKQZMW0H8"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ====== Admin 列表（前端隐藏导入按钮；真正权限靠规则） ====== */
const ADMIN_EMAILS = ["principal@harmonytx.org", "ap@harmonytx.org"];

/* ====== DOM ====== */
const whoEl = document.getElementById('who');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const importWrap = document.getElementById('importWrap');
const csvInput = document.getElementById('csv');
const studentInput = document.getElementById('studentInput');
const dropdown = document.getElementById('dropdown');
const recordBtn = document.getElementById('recordBtn');
const emg = document.getElementById('emg');
const gradeSel = document.getElementById('gradeSel');
const homeSel = document.getElementById('homeSel');
const list = document.getElementById('list');
const tbody = document.getElementById('tbody');
const msg = document.getElementById('msg');
const emptyMsg = document.getElementById('emptyMsg');
const domainAlert = document.getElementById('domainAlert');
const recentChips = document.getElementById('recentChips');
const exportBtn = document.getElementById('exportBtn');
const scanBtn = document.getElementById('scanBtn');
const video = document.getElementById('video');
const alertBox = document.getElementById('alerts');
const alertList = document.getElementById('alertList');
const alertNInput = document.getElementById('alertN');

/* ====== Helpers ====== */
function chicagoDayParts(d=new Date()){
  const ps = new Intl.DateTimeFormat('en-CA',{timeZone:'America/Chicago',year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d);
  return { y:ps.find(p=>p.type==='year').value, m:ps.find(p=>p.type==='month').value, d:ps.find(p=>p.type==='day').value };
}
function dayKey(d=new Date()){ const {y,m,d:dd}=chicagoDayParts(d); return `${y}-${m}-${dd}`; }
function formatChicago(ts){ const date=ts?.toDate?ts.toDate():new Date(ts); return new Intl.DateTimeFormat('en-US',{timeZone:'America/Chicago',hour:'2-digit',minute:'2-digit'}).format(date); }
function download(filename, text){
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/csv;charset=utf-8;'})); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1500);
}

/* ====== Roster ====== */
let roster=[], rosterByName=new Map(), rosterById=new Map(), grades=new Set(), homes=new Set();

async function loadRoster(){
  const snap = await db.collection('students').get();
  roster = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  rosterByName = new Map(roster.map(s=>[String(s.name).trim().toLowerCase(), s.id]));
  rosterById = new Map(roster.map(s=>[s.id, s]));
  grades = new Set(roster.map(s=>s.grade).filter(Boolean));
  homes = new Set(roster.map(s=>s.homeroom).filter(Boolean));
  // 填充筛选
  gradeSel.innerHTML = `<option value="">All</option>` + [...grades].sort().map(g=>`<option value="${g}">${g}</option>`).join('');
  homeSel.innerHTML = `<option value="">All</option>` + [...homes].sort().map(h=>`<option value="${h}">${h}</option>`).join('');
}

csvInput.addEventListener('change', async e=>{
  const u=auth.currentUser; if(!u) return alert('Sign in first.');
  const file=e.target.files[0]; if(!file) return;
  const text=await file.text();
  // CSV: name,grade,homeroom （无表头更稳；若第一行像表头会自动跳过）
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const batch=db.batch();
  for(const line of lines){
    const parts=line.split(',').map(s=>s.replace(/^"|"$/g,'').trim());
    let [name,grade,homeroom] = [parts[0]||'', parts[1]||'', parts[2]||''];
    if(!name || name.toLowerCase()==='name') continue;
    const ref=db.collection('students').doc();
    batch.set(ref,{ name, grade, homeroom, createdAt: firebase.firestore.Timestamp.now() });
  }
  await batch.commit();
  await loadRoster();
  alert('Roster imported.');
});

/* ====== Auto-suggest + Recent ====== */
let suggestions=[];
studentInput.addEventListener('input', ()=>{
  const q=studentInput.value.trim().toLowerCase();
  if(!q){ dropdown.classList.add('hidden'); dropdown.innerHTML=''; return; }
  const matches = roster.filter(r=> r.name && r.name.toLowerCase().includes(q)).slice(0,10);
  suggestions=matches;
  if(!matches.length){ dropdown.classList.add('hidden'); dropdown.innerHTML=''; return; }
  dropdown.innerHTML = matches.map(m=>`<div data-id="${m.id}" data-name="${m.name}">${m.name} — ${m.grade||''} ${m.homeroom||''}</div>`).join('');
  dropdown.classList.remove('hidden');
});
dropdown.addEventListener('click', e=>{
  const t=e.target; if(t?.dataset?.id){ studentInput.value=t.dataset.name; dropdown.classList.add('hidden'); dropdown.innerHTML=''; }
});
let recent=[];
function pushRecent(name){
  if(!name) return;
  recent = [name, ...recent.filter(n=>n!==name)].slice(0,10);
  renderRecent();
}
function renderRecent(){
  recentChips.innerHTML = recent.map(n=>`<span class="chip">${n}</span>`).join('');
}
recentChips.addEventListener('click', e=>{
  const t=e.target; if(t.classList.contains('chip')){ studentInput.value=t.textContent; }
});

/* ====== Today (counts & passes) ====== */
let unsubCounts=null, unsubPasses=null, todaysRows=[];
function filterBySelectors(studentId){
  const s = rosterById.get(studentId); if(!s) return true;
  const g=gradeSel.value, h=homeSel.value;
  if(g && s.grade!==g) return false;
  if(h && s.homeroom!==h) return false;
  return true;
}
function watchToday(){
  const key=dayKey(new Date());
  if(unsubCounts) unsubCounts();
  unsubCounts = db.collection('counts').doc(key).collection('students')
    .onSnapshot(snap=>{
      const rows=snap.docs.map(d=>({ studentId:d.id, ...(d.data()) }));
      renderCounts(rows);
    });

  if(unsubPasses) unsubPasses();
  unsubPasses = db.collection('passes').where('dayKey','==',key)
    .onSnapshot(snap=>{
      todaysRows = snap.docs.map(d=>d.data());
      renderTable(todaysRows);
    });
}

function renderCounts(entries){
  // 合并 roster 信息 + 筛选
  const items = entries
    .map(e=>({ ...e, s: rosterById.get(e.studentId)||{} }))
    .filter(e=> filterBySelectors(e.studentId));

  items.sort((a,b)=>(b.count||0)-(a.count||0));

  list.innerHTML='';
  emptyMsg.style.display = items.length? 'none':'block';
  for(const e of items){
    const name = e.s.name || e.studentName || e.studentId;
    const li=document.createElement('li'); li.className='item';
    li.innerHTML = `<span>${name} ${e.s.grade?('— '+e.s.grade):''} ${e.s.homeroom?(' '+e.s.homeroom):''}</span>
                    <span class="badge ${e.count>=3?'danger':''}">${e.count||0}/3</span>`;
    list.appendChild(li);
  }
}

function renderTable(rows){
  const sorted=[...rows].sort((a,b)=>{
    const at=a.createdAt?.toMillis?a.createdAt.toMillis():0;
    const bt=b.createdAt?.toMillis?b.createdAt.toMillis():0;
    return bt-at;
  });
  tbody.innerHTML='';
  for(const p of sorted){
    if(!filterBySelectors(p.studentId)) continue;
    const s=rosterById.get(p.studentId)||{};
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${p.createdAt?formatChicago(p.createdAt):''}</td>
                    <td>${s.name||p.studentName||''}</td>
                    <td>${s.grade||''}</td>
                    <td>${s.homeroom||''}</td>
                    <td>${p.teacherEmail||''}</td>
                    <td>${p.isEmergency?'Yes':'No'}</td>`;
    tbody.appendChild(tr);
  }
}

/* ====== Create record (batch: pass + counts increment) ====== */
const lastClick=new Map();
async function createRecordByStudentName(name, isEmergency){
  const u=auth.currentUser; if(!u){ alert('Please sign in.'); return; }
  name=(name||'').trim(); if(!name) return;

  // 30s 防连点
  const nowMs=Date.now(), last=lastClick.get(name);
  if(last && (nowMs-last)<30_000){ msg.textContent='Duplicate click ignored (30s).'; return; }

  // 找 studentId（无则创建）
  let sid= rosterByName.get(name.toLowerCase());
  if(!sid){
    // 非管理员也允许创建？按你们管理政策决定。默认允许老师新增（方便补漏）。
    const doc=db.collection('students').doc();
    await doc.set({ name, grade:'', homeroom:'', createdAt: firebase.firestore.Timestamp.now() });
    sid=doc.id;
    await loadRoster();
  }

  // 今日非紧急次数（从 counts 读）
  const key=dayKey(new Date());
  const countRef=db.collection('counts').doc(key).collection('students').doc(sid);
  const snap=await countRef.get();
  const current=snap.exists?(snap.data().count||0):0;
  if(!isEmergency && current>=3){ msg.textContent='Reached daily limit (3).'; return; }

  const passRef=db.collection('passes').doc();
  const batch=db.batch();
  batch.set(passRef,{
    studentId:sid,
    studentName:name,
    teacherUid:u.uid,
    teacherEmail:u.email||'',
    isEmergency:!!isEmergency,
    createdAt: firebase.firestore.Timestamp.now(),
    dayKey:key
  });
  if(!isEmergency){
    batch.set(countRef,{ count: firebase.firestore.FieldValue.increment(1) },{merge:true});
  }
  await batch.commit();
  lastClick.set(name, Date.now());
  msg.textContent='Recorded ✅';
  pushRecent(name);
}

recordBtn.addEventListener('click', ()=> createRecordByStudentName(studentInput.value, emg.checked));

/* ====== 筛选变化时刷新 ====== */
gradeSel.addEventListener('change', ()=>{ renderCounts([]); renderCountsCache(); renderTable(todaysRows); });
homeSel.addEventListener('change', ()=>{ renderCounts([]); renderCountsCache(); renderTable(todaysRows); });
function renderCountsCache(){
  // 轻触 counts 重新渲染：读取当前订阅的 DOM 上已有 entries
  // 实际上 onSnapshot 会带来新 entries，这里什么也不用做
}

/* ====== 登录 ====== */
loginBtn.onclick = async ()=>{
  try{
    const provider=new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  }catch(e){
    console.error(e);
    if(String(e?.code).includes('auth/unauthorized-domain')){
      const host=location.host;
      domainAlert.classList.remove('hidden');
      domainAlert.innerHTML=`<div><b>当前域名未加入 Firebase 白名单：</b> <code>${host}</code></div>
      <ol style="margin:6px 0 0 18px;">
        <li>Firebase → Authentication → Settings → Authorized domains</li>
        <li>Add domain：<code>${host}</code>；建议一并添加 <code>lubbock-hsa-bathroom-pass.vercel.app</code>、<code>localhost</code></li>
        <li>保存后强刷（Ctrl+F5 / Cmd+Shift+R）再登录</li></ol>`;
      alert('This domain is not authorized for Google sign-in.');
    }else{ alert('Google sign-in failed. See console.'); }
  }
};
logoutBtn.onclick=()=>auth.signOut();

auth.onAuthStateChanged(async u=>{
  if(u){
    whoEl.textContent=`Signed in as ${u.email||u.uid}`;
    loginBtn.classList.add('hidden'); logoutBtn.classList.remove('hidden');
    // 只有管理员显示导入按钮
    importWrap.classList.toggle('hidden', !ADMIN_EMAILS.includes((u.email||'').toLowerCase()));
    await loadRoster();
    watchToday();
  }else{
    whoEl.textContent='Not signed in';
    loginBtn.classList.remove('hidden'); logoutBtn.classList.add('hidden');
    if(unsubCounts)unsubCounts(); if(unsubPasses)unsubPasses();
    roster=[]; rosterByName=new Map(); rosterById=new Map(); todaysRows=[];
    list.innerHTML=''; tbody.innerHTML=''; emptyMsg.style.display='block';
  }
});

/* ====== 导出最近 7 天 CSV ====== */
exportBtn.onclick = async ()=>{
  const today=new Date();
  const days=[];
  for(let i=0;i<7;i++){ const d=new Date(today); d.setDate(d.getDate()-i); days.push(dayKey(d)); }
  // 拉取 7 天 counts
  const maps=[]; // [{sid->count}, ...]
  for(const k of days){
    const col=await db.collection('counts').doc(k).collection('students').get();
    const m=new Map(); col.docs.forEach(doc=>{ m.set(doc.id, doc.data().count||0); }); maps.push(m);
  }
  // 组合 CSV：Student,Grade,Homeroom, d0..d6, Total
  const headers=['Student','Grade','Homeroom', ...days.map(d=>d), 'Total'];
  const rows=[headers.join(',')];
  // 基于筛选项导出
  const filtered = roster.filter(s=>{
    const g=gradeSel.value, h=homeSel.value;
    if(g && s.grade!==g) return false;
    if(h && s.homeroom!==h) return false;
    return true;
  });
  for(const s of filtered){
    const counts=maps.map(m=> m.get(s.id)||0 );
    const total=counts.reduce((a,b)=>a+b,0);
    const line=[`"${s.name||''}"`,`"${s.grade||''}"`,`"${s.homeroom||''}"`, ...counts, total].join(',');
    rows.push(line);
  }
  download(`bathroom-7days-${dayKey(today)}.csv`, rows.join('\n'));

  // 异常提醒（7 天 > N）
  const N = parseInt(alertNInput.value||'5',10);
  const alerts=[];
  for(const s of filtered){
    const counts=maps.map(m=> m.get(s.id)||0 );
    const total=counts.reduce((a,b)=>a+b,0);
    if(total>N) alerts.push({ s, total });
  }
  alertList.innerHTML = alerts.map(a=>`<li>${a.s.name} — ${a.total} in 7 days (${a.s.grade||''} ${a.s.homeroom||''})</li>`).join('');
  alertBox.classList.toggle('hidden', alerts.length===0);
};

/* ====== 扫码（可选）：浏览器支持 BarcodeDetector 时可用 ====== */
let scanning=false, detector=null, stream=null;
scanBtn.onclick = async ()=>{
  if(scanning){ // stop
    scanning=false; scanBtn.textContent='Scan'; video.classList.add('hidden');
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    return;
  }
  scanning=true; scanBtn.textContent='Stop'; video.classList.remove('hidden');
  try{
    if('BarcodeDetector' in window){
      detector = new BarcodeDetector({ formats: ['qr_code']});
    }else{
      msg.textContent='BarcodeDetector not supported on this device.';
      return;
    }
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
    video.srcObject=stream; await video.play();
    const tick=async ()=>{
      if(!scanning) return;
      const barcodes = await detector.detect(video);
      if(barcodes.length){
        const code = barcodes[0].rawValue || '';
        // 约定二维码内容为 studentId
        const s = rosterById.get(code);
        if(s){ studentInput.value=s.name; await createRecordByStudentName(s.name, emg.checked); }
        else { msg.textContent='QR not in roster.'; }
        scanBtn.click(); // stop
        return;
      }
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  }catch(err){
    console.error(err);
    msg.textContent='Camera/scan error. See console.';
    scanBtn.click(); // stop
  }
};
</script>
</body>
</html>
