<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>HSA Lubbock · Bathroom Pass</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<script>
  // 自动跳转到正式域名，避免 OAuth 域名错误
  if (location.hostname !== "lubbock-hsa-bathroom-pass.vercel.app" && location.hostname !== "localhost") {
    location.href = "https://lubbock-hsa-bathroom-pass.vercel.app";
  }
</script>

<h1>Bathroom Pass System</h1>

<!-- 登录按钮 -->
<button id="loginBtn">Sign in with Google</button>
<div id="userInfo"></div>

<!-- Quick Record -->
<h2>Quick Record</h2>
<input type="text" id="studentName" placeholder="Student Name" />
<button id="recordBtn">Record</button>

<!-- 今日统计 -->
<h2>Today’s Counts (Max 3)</h2>
<ul id="todayList"></ul>

<!-- 最新记录 -->
<h2>Latest Records</h2>
<table border="1">
  <thead>
    <tr>
      <th>Time</th>
      <th>Student</th>
      <th>Teacher</th>
      <th>Emergency</th>
    </tr>
  </thead>
  <tbody id="latestTable"></tbody>
</table>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

<script>
  // Firebase 配置
  const firebaseConfig = {
    apiKey: "AIzaSyBXYe18Z-KN6sS_QdGXEqW8Zb4RBxtYoVM",
    authDomain: "lubbock-hsa-bathroom-pass.firebaseapp.com",
    projectId: "lubbock-hsa-bathroom-pass",
    storageBucket: "lubbock-hsa-bathroom-pass.firebasestorage.app",
    messagingSenderId: "20266028833",
    appId: "1:20266028833:web:5219b6cfa07da654807860",
    measurementId: "G-ENKQZMW0H8"
  };

  // 初始化 Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // 登录
  document.getElementById("loginBtn").onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then(result => {
        document.getElementById("userInfo").innerText = `Signed in as ${result.user.email}`;
      })
      .catch(err => console.error(err));
  };

  // 记录上厕所
  document.getElementById("recordBtn").onclick = async () => {
    const student = document.getElementById("studentName").value.trim();
    if (!student) return alert("Please enter student name");
    const teacher = auth.currentUser ? auth.currentUser.email : "Unknown";
    await db.collection("passes").add({
      studentName: student,
      teacher: teacher,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      emergency: false
    });
    alert("Recorded!");
  };

  // 显示今日统计
  function loadTodayCounts() {
    const today = new Date();
    today.setHours(0,0,0,0);
    db.collection("passes")
      .where("createdAt", ">=", today)
      .orderBy("createdAt", "desc")
      .onSnapshot(snapshot => {
        const counts = {};
        snapshot.forEach(doc => {
          const data = doc.data();
          counts[data.studentName] = (counts[data.studentName] || 0) + 1;
        });
        const ul = document.getElementById("todayList");
        ul.innerHTML = "";
        for (let student in counts) {
          const li = document.createElement("li");
          li.innerText = `${student} ${counts[student]}/3`;
          ul.appendChild(li);
        }
      });
  }

  // 显示最新记录
  function loadLatestRecords() {
    db.collection("passes")
      .orderBy("createdAt", "desc")
      .limit(10)
      .onSnapshot(snapshot => {
        const tbody = document.getElementById("latestTable");
        tbody.innerHTML = "";
        snapshot.forEach(doc => {
          const d = doc.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.createdAt?.toDate().toLocaleString() || ""}</td>
            <td>${d.studentName}</td>
            <td>${d.teacher}</td>
            <td>${d.emergency ? "Yes" : "No"}</td>
          `;
          tbody.appendChild(tr);
        });
      });
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById("userInfo").innerText = `Signed in as ${user.email}`;
      loadTodayCounts();
      loadLatestRecords();
    }
  });
</script>
</body>
</html>
