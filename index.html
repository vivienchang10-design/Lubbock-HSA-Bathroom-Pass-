<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bathroom Pass – HSA Lubbock</title>
  <style>
    :root { --pad: 14px; --radius: 14px; --border: #ddd; --muted:#666; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; color:#111; }
    header, main { max-width: 900px; margin: 0 auto; padding: var(--pad); }
    .card { border:1px solid var(--border); border-radius: var(--radius); padding: var(--pad); box-shadow: 0 1px 4px rgba(0,0,0,.04); }
    .row { display:flex; gap:12px; align-items:center; }
    .grow { flex:1; }
    input[type=text] { width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); }
    button { padding:10px 14px; border:1px solid var(--border); border-radius:12px; background:#fff; cursor:pointer; }
    button.primary { border-color:#222; }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 720px){ .grid{ grid-template-columns: 1fr 1fr; } }
    ul { list-style:none; padding:0; margin:0; }
    li.item { display:flex; align-items:center; justify-content:space-between; border:1px solid var(--border); border-radius: 12px; padding:10px 12px; }
    .muted{ color:var(--muted); font-size: 12px;}
    .danger{ color:#b00020; font-weight:600; }
    .ok{ font-weight:600; }
    .hidden{ display:none; }
    .badge{ font-size:12px; border:1px solid var(--border); border-radius:999px; padding:3px 8px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px 10px; border-bottom:1px solid var(--border); text-align:left; }
    th { font-size:12px; color:#444; }
  </style>
</head>
<body>
<header class="row">
  <div class="grow">
    <h1 style="margin:0 0 4px;">Bathroom Pass</h1>
    <div id="who" class="muted">Not signed in</div>
  </div>
  <div class="row">
    <button id="loginBtn" class="primary">Sign in with Google</button>
    <button id="logoutBtn" class="hidden">Logout</button>
  </div>
</header>

<main>
  <!-- Quick Record -->
  <section class="card">
    <h2 style="margin:0 0 10px;">Quick Record</h2>
    <form id="recordForm" class="row" autocomplete="off">
      <input id="studentInput" class="grow" type="text" placeholder="Type student name (e.g., Student A)" required />
      <label class="row" style="gap:6px; font-size:14px;"><input id="emg" type="checkbox" /> Emergency/Exempt</label>
      <button type="submit" class="primary">Record</button>
    </form>
    <div class="muted" style="margin-top:6px;">• Max 3 per day (America/Chicago). Emergency entries don’t count toward the limit.</div>
    <div id="msg" class="muted" style="margin-top:6px;"></div>
  </section>

  <!-- Today Counts -->
  <section class="grid" style="margin-top:16px;">
    <div class="card">
      <h3 style="margin:0 0 8px;">Today’s Counts (Max 3)</h3>
      <div id="emptyMsg" class="muted">No records yet.</div>
      <ul id="list"></ul>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">Latest Records (today)</h3>
      <table id="table">
        <thead><tr><th>Time (CT)</th><th>Student</th><th>Teacher</th><th>Emergency</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Firebase SDKs (compat for simplicity) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script type="text/javascript">
  // ==== Firebase config (yours) ====
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBXYe18Z-KN6sS_QdGXEqW8Zb4RBxtYoVM",
    authDomain: "lubbock-hsa-bathroom-pass.firebaseapp.com",
    projectId: "lubbock-hsa-bathroom-pass",
    storageBucket: "lubbock-hsa-bathroom-pass.firebasestorage.app",
    messagingSenderId: "20266028833",
    appId: "1:20266028833:web:5219b6cfa07da654807860",
    measurementId: "G-ENKQZMW0H8"
  };

  // ==== Init ====
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ==== Elements ====
  const whoEl = document.getElementById('who');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const form = document.getElementById('recordForm');
  const input = document.getElementById('studentInput');
  const emg = document.getElementById('emg');
  const list = document.getElementById('list');
  const tbody = document.getElementById('tbody');
  const msg = document.getElementById('msg');
  const emptyMsg = document.getElementById('emptyMsg');

  // ==== Auth UI ====
  loginBtn.onclick = async () => {
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    } catch (e) { console.error(e); alert('Google sign-in failed. See console.'); }
  };
  logoutBtn.onclick = () => auth.signOut();

  // ==== Time helpers (America/Chicago day range) ====
  function chicagoDayRange(now = new Date()){
    const parts = new Intl.DateTimeFormat('en-US', { timeZone: 'America/Chicago', year: 'numeric', month:'2-digit', day:'2-digit'}).formatToParts(now);
    const y = parts.find(p=>p.type==='year').value;
    const m = parts.find(p=>p.type==='month').value;
    const d = parts.find(p=>p.type==='day').value;
    const localMidnight = new Date(new Date(`${y}-${m}-${d}T00:00:00`).toLocaleString('en-US', { timeZone: 'America/Chicago' }));
    const startUtc = new Date(Date.UTC(localMidnight.getFullYear(), localMidnight.getMonth(), localMidnight.getDate(), 0,0,0));
    const endUtc = new Date(startUtc.getTime() + 24*60*60*1000);
    return { startUtc, endUtc };
  }
  function formatChicago(ts){
    const date = ts.toDate ? ts.toDate() : new Date(ts);
    return new Intl.DateTimeFormat('en-US', { timeZone: 'America/Chicago', hour:'2-digit', minute:'2-digit' }).format(date);
  }

  // ==== In-memory cache of today's rows (to avoid re-query for POST) ====
  let todaysRows = [];

  // ==== Renderers ====
  function renderCounts(rows){
    const counts = {};
    rows.forEach(p => { if (!p.isEmergency) counts[p.studentName] = (counts[p.studentName]||0)+1; });

    list.innerHTML = '';
    const entries = Object.entries(counts);
    emptyMsg.style.display = entries.length ? 'none' : 'block';
    entries.forEach(([name, c])=>{
      const li = document.createElement('li');
      li.className = 'item';
      const span = document.createElement('span');
      span.textContent = name;
      const badge = document.createElement('span');
      badge.className = 'badge ' + (c>=3? 'danger':'ok');
      badge.textContent = `${c}/3`;
      li.appendChild(span);
      li.appendChild(badge);
      list.appendChild(li);
    });
  }

  function renderTable(rows){
    tbody.innerHTML = '';
    rows.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.createdAt ? formatChicago(p.createdAt) : ''}</td>
                      <td>${p.studentName || ''}</td>
                      <td>${p.teacherEmail || ''}</td>
                      <td>${p.isEmergency ? 'Yes':'No'}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ==== Live query for today's records (no composite index needed) ====
  let unsubscribe = null;
  function watchToday(){
    if (unsubscribe) unsubscribe();
    const { startUtc, endUtc } = chicagoDayRange(new Date());

    unsubscribe = db.collection('passes')
      .where('createdAt', '>=', startUtc)
      .where('createdAt', '<', endUtc)
      .orderBy('createdAt', 'desc') // 单字段 createdAt，Firestore 自动索引，OK
      .onSnapshot(snap => {
        const rows = [];
        snap.forEach(doc => rows.push(doc.data()));
        todaysRows = rows;            // 缓存今天的全部记录
        renderCounts(rows);
        renderTable(rows);
      }, err => {
        console.error('Snapshot error:', err);
        alert('Reading data failed (see console). Check Firestore rules/domains/login.');
      });
  }

  // ==== Create pass (client-side limit check using todaysRows; no composite index) ====
  const lastClick = new Map(); // local 30s guard per student
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const u = auth.currentUser;
    if (!u) { alert('Please sign in.'); return; }

    const name = input.value.trim();
    if (!name) return;
    const emergency = !!emg.checked;

    // 30s guard (local)
    const nowMs = Date.now();
    const last = lastClick.get(name);
    if (last && (nowMs - last) < 30_000) {
      msg.textContent = 'Duplicate click ignored (within 30s).';
      input.value = '';
      emg.checked = false;
      return;
    }

    try {
      // 用已经监听到的 todaysRows 在前端过滤该学生今天的非紧急次数
      const nonEmergencyCount = todaysRows.reduce((acc, p) => {
        return acc + ((p.studentName === name && !p.isEmergency) ? 1 : 0);
      }, 0);

      if (!emergency && nonEmergencyCount >= 3) {
        msg.textContent = 'Reached daily limit (3).';
        input.value = '';
        emg.checked = false;
        return;
      }

      await db.collection('passes').add({
        studentName: name,
        teacherUid: u.uid,
        teacherEmail: u.email || '',
        isEmergency: emergency,
        // 立即可见（不等 serverTimestamp 回填）
        createdAt: firebase.firestore.Timestamp.now(),
      });

      lastClick.set(name, Date.now());
      msg.textContent = 'Recorded ✅';
      input.value = '';
      emg.checked = false;
      // 不需要手动刷新，onSnapshot 会自动更新 todaysRows/列表
    } catch (err) {
      console.error(err);
      alert('Creating record failed (see console).');
    }
  });

  // ==== Auth state ====
  auth.onAuthStateChanged(u=>{
    if (u){
      whoEl.textContent = `Signed in as ${u.email || u.uid}`;
      loginBtn.classList.add('hidden');
      logoutBtn.classList.remove('hidden');
      watchToday();
    } else {
      whoEl.textContent = 'Not signed in';
      loginBtn.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      if (unsubscribe) unsubscribe();
      todaysRows = [];
      list.innerHTML = '';
      tbody.innerHTML = '';
      emptyMsg.style.display = 'block';
    }
  });
</script>

</body>
</html>
