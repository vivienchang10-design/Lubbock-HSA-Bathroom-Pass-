<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>HSA Bathroom Pass</title>
  <script type="module">
    // =================== Firebase 初始化 ===================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getFirestore, doc, getDoc, collection, addDoc, serverTimestamp, 
      query, where, orderBy, limit, getDocs 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { 
      getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "你的APIKEY",
      authDomain: "你的PROJECTID.firebaseapp.com",
      projectId: "你的PROJECTID",
      storageBucket: "你的PROJECTID.appspot.com",
      messagingSenderId: "xxxx",
      appId: "xxxx"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    // =================== 登录相关 ===================
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfo = document.getElementById("userInfo");

    loginBtn.addEventListener("click", async () => {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        userInfo.innerText = user.email;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        document.getElementById("main").style.display = "block";
      } else {
        userInfo.innerText = "";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        document.getElementById("main").style.display = "none";
      }
    });

    // =================== 自动获取学生信息 ===================
    document.getElementById("studentNumber").addEventListener("change", async () => {
      const number = document.getElementById("studentNumber").value.trim();
      if (!number) return;

      try {
        const studentRef = doc(db, "students", number); // Document ID = 学生编号
        const studentSnap = await getDoc(studentRef);

        if (studentSnap.exists()) {
          const studentData = studentSnap.data();
          document.getElementById("studentName").value = `${studentData.name} - ${studentData.grade}`;
        } else {
          document.getElementById("studentName").value = "";
          alert("未找到该学生编号，请检查 students 集合。");
        }
      } catch (error) {
        console.error("Error fetching student:", error);
        alert("获取学生信息失败，请稍后再试。");
      }
    });

    // =================== 记录上厕所 ===================
    document.getElementById("recordBtn").addEventListener("click", async () => {
      const number = document.getElementById("studentNumber").value.trim();
      if (!number) return alert("请输入学生编号");

      const nameField = document.getElementById("studentName").value.trim();
      if (!nameField) return alert("请先输入有效的学生编号");

      const [name, grade] = nameField.split(" - ");

      try {
        await addDoc(collection(db, "passes"), {
          number,
          name,
          grade,
          teacher: auth.currentUser.email,
          timestamp: serverTimestamp()
        });
        alert("Recorded ✅");
      } catch (error) {
        console.error(error);
        alert("记录失败");
      }
    });
  </script>
</head>
<body>
  <button id="loginBtn">Login with Google</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
  <span id="userInfo"></span>

  <div id="main" style="display:none;">
    <h2>Bathroom Pass</h2>
    <label>Student # (1–600):</label>
    <input type="number" id="studentNumber" min="1" max="600">
    <br>
    <label>Name (auto):</label>
    <input type="text" id="studentName" readonly>
    <br><br>
    <button id="recordBtn">Record Bathroom Pass</button>
  </div>
</body>
</html>
