<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>HSA Lubbock · Bathroom Pass</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <h1>HSA Lubbock · Bathroom Pass</h1>

  <div id="loginDiv">
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>

  <div id="appDiv" style="display:none;">
    <p id="userEmail"></p>
    <button onclick="logout()">Logout</button>
    <h3>Student</h3>
    <select id="studentSelect">
      <option>Student A</option>
      <option>Student B</option>
      <option>Student C</option>
      <option>Student D</option>
      <option>Student E</option>
      <option>Student F</option>
    </select>
    <button onclick="logOne()">Record Bathroom Pass</button>
    <p>Limit is 3 per day (per student).</p>

    <h3>Today</h3>
    <table border="1">
      <thead>
        <tr>
          <th>Student</th>
          <th>Count</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="todayTable"></tbody>
    </table>

    <h3>Last 7 days</h3>
    <table border="1">
      <thead>
        <tr>
          <th>Time</th>
          <th>Student</th>
          <th>Teacher</th>
          <th>Over 3?</th>
        </tr>
      </thead>
      <tbody id="historyTable"></tbody>
    </table>
  </div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBXYe18Z-KN6sS_QdGXEqW8Zb4RBxtYoVM",
    authDomain: "lubbock-hsa-bathroom-pass.firebaseapp.com",
    projectId: "lubbock-hsa-bathroom-pass",
    storageBucket: "lubbock-hsa-bathroom-pass.appspot.com",
    messagingSenderId: "20266028833",
    appId: "1:20266028833:web:5219b6cfa07da654807860",
    measurementId: "G-ENKQZMW0H8"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('appDiv').style.display = 'block';
        document.getElementById('userEmail').innerText = auth.currentUser.email;
        loadData();
      })
      .catch(err => alert(err.message));
  }

  function logout() {
    auth.signOut();
    document.getElementById('loginDiv').style.display = 'block';
    document.getElementById('appDiv').style.display = 'none';
  }

  // 修复后的 logOne 函数
  function logOne() {
    const student = document.getElementById('studentSelect').value;
    const teacher = auth.currentUser.email;
    const todayDate = new Date().toISOString().split('T')[0];

    const todayStart = new Date(todayDate + "T00:00:00");
    const todayEnd = new Date(todayDate + "T23:59:59");

    db.collection("passes")
      .where("student", "==", student)
      .where("time", ">=", todayStart.toISOString())
      .where("time", "<=", todayEnd.toISOString())
      .get()
      .then(snapshot => {
        if (snapshot.size >= 3) {
          alert(student + " 已经达到今日 3 次限制");
          return;
        }
        db.collection("passes").add({
          student: student,
          teacher: teacher,
          time: new Date().toISOString()
        }).then(() => {
          alert("记录成功！");
          loadData();
        });
      });
  }

  function loadData() {
    const todayDate = new Date().toISOString().split('T')[0];
    const todayStart = new Date(todayDate + "T00:00:00");
    const todayEnd = new Date(todayDate + "T23:59:59");

    const students = ["Student A","Student B","Student C","Student D","Student E","Student F"];
    const todayTable = document.getElementById("todayTable");
    todayTable.innerHTML = "";

    students.forEach(stu => {
      db.collection("passes")
        .where("student", "==", stu)
        .where("time", ">=", todayStart.toISOString())
        .where("time", "<=", todayEnd.toISOString())
        .get()
        .then(snapshot => {
          const count = snapshot.size;
          const row = `<tr>
            <td>${stu}</td>
            <td>${count}/3</td>
            <td>${count >= 3 ? "LIMIT" : "OK"}</td>
          </tr>`;
          todayTable.innerHTML += row;
        });
    });

    const historyTable = document.getElementById("historyTable");
    historyTable.innerHTML = "";
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

    db.collection("passes")
      .where("time", ">=", sevenDaysAgo.toISOString())
      .orderBy("time", "desc")
      .get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          const d = doc.data();
          const over3 = false; // 可以按需计算
          const row = `<tr>
            <td>${d.time}</td>
            <td>${d.student}</td>
            <td>${d.teacher}</td>
            <td>${over3}</td>
          </tr>`;
          historyTable.innerHTML += row;
        });
      });
  }
</script>
</body>
</html>
